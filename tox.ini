[tox]
requires  = tox>=4.15
env_list  =
    lint
    type
    py311-sqlite
    py312-sqlite
    py313-sqlite
    py312-postgres
    coverage
isolated_build = true

#  Common settings 
[testenv]
package            = wheel
wheel_build_env    = .pkg
extras             = dev,full
set_env =
    PYTHONPATH = src
    PYTHONDONTWRITEBYTECODE = 1
commands =
    pytest {posargs} -q

#  SQLite matrix (no external services)
[testenv:py311-sqlite]
base_python = python3.11
extras      = dev,full

[testenv:py312-sqlite]
base_python = python3.12
extras      = dev,full

[testenv:py313-sqlite]
base_python = python3.13
extras      = dev,full

#  PostgreSQL integration 
[testenv:py312-postgres]
base_python = python3.12
extras      = dev,postgres,redis,migrations
set_env =
    {[testenv]set_env}
    TENANCY_DATABASE_URL = postgresql+asyncpg://testuser:testpass@localhost:5432/testdb
    TENANCY_REDIS_URL    = redis://localhost:6379/0
commands =
    pytest {posargs} -q

#  Lint 
[testenv:lint]
skip_install = true
deps         = ruff>=0.4.0
commands =
    ruff format --check src
    ruff check src

#  Type checking
[testenv:type]
extras = dev,full
deps   =
    mypy>=1.10.0
    sqlalchemy[mypy]>=2.0.30
commands =
    mypy src --ignore-missing-imports

#  Coverage report
[testenv:coverage]
extras = dev,full
commands =
    pytest -m "not e2e" --cov --cov-report=xml --cov-report=term-missing -q
    coverage report --fail-under=75

#  Security audit 
[testenv:audit]
skip_install = true
deps         = pip-audit
commands     = pip-audit --fix --dry-run

#  Build check
[testenv:build]
skip_install = true
deps         = build hatchling twine
commands =
    python -m build --wheel --sdist
    twine check dist/*
